name: CD - Build, Test and Deploy (with deep debug)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"

jobs:
  test-before-deploy:
    name: Test before deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r booking_service/requirements.txt
          pip install -r cleaning_service/requirements.txt
          pip install pytest pytest-cov httpx prometheus-fastapi-instrumentator

      - name: Run unit tests (if exist)
        run: |
          set -euo pipefail
          export PYTHONPATH="$GITHUB_WORKSPACE"
          if ls tests/test_*_unit.py >/dev/null 2>&1; then
            pytest -q tests/test_*_unit.py -v --tb=short
          else
            echo "No unit tests found (tests/test_*_unit.py), skipping..."
          fi

      - name: Run integration tests (if exist)
        run: |
          set -euo pipefail
          export PYTHONPATH="$GITHUB_WORKSPACE"
          if ls tests/test_*_integration.py >/dev/null 2>&1; then
            pytest -q tests/test_*_integration.py -v --tb=short
          else
            echo "No integration tests found (tests/test_*_integration.py), skipping..."
          fi

  build-and-push-ycr:
    name: Build and push to YCR
    runs-on: ubuntu-latest
    needs: [test-before-deploy]
    strategy:
      matrix:
        service: [booking_service, cleaning_service]

    steps:
      - uses: actions/checkout@v4

      - name: ‚úÖ Verify required secrets presence (safe)
        run: |
          set -euo pipefail

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å (–Ω–µ –ø–µ—á–∞—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è)
          [ -n "${{ secrets.YC_KEYS }}" ] || (echo "YC_KEYS is EMPTY" && exit 1)
          [ -n "${{ secrets.YC_REGISTRY_ID }}" ] || (echo "YC_REGISTRY_ID is EMPTY" && exit 1)

          # –ú–∞—Å–∫–∏—Ä—É–µ–º –∏ –ø–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω—ã/–ø—Ä–µ—Ñ–∏–∫—Å—ã
          echo "YC_REGISTRY_ID length: ${#{{ secrets.YC_REGISTRY_ID }}}"
          echo "YC_REGISTRY_ID prefix: $(echo '${{ secrets.YC_REGISTRY_ID }}' | cut -c1-3)***"

      - name: üîé Parse YC_KEYS JSON (safe IDs only)
        env:
          YC_KEYS: ${{ secrets.YC_KEYS }}
        run: |
          set -euo pipefail
          python - <<'PY'
import json, os
j = json.loads(os.environ["YC_KEYS"])
print("YC_KEYS.service_account_id =", j.get("service_account_id"))
print("YC_KEYS.cloud_id          =", j.get("cloud_id"))
print("YC_KEYS.folder_id         =", j.get("folder_id"))
# –Ω–∏—á–µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –Ω–µ –ø–µ—á–∞—Ç–∞–µ–º
PY

      - name: Auth to Yandex Container Registry
        uses: yc-actions/yc-cr-login@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_KEYS }}

      - name: üß™ Smoke: docker is logged in & can see YCR registry
        uses: yc-actions/yc-setup@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_KEYS }}

      - name: üß™ Smoke: yc CLI identity + registry list
        run: |
          set -euo pipefail
          yc --version
          yc config list || true

          echo "Try list registries in current folder (may require permissions)..."
          yc container registry list || true

          echo "Try get registry by ID (from secret)..."
          yc container registry get "${{ secrets.YC_REGISTRY_ID }}" || true

      - name: Build & push (latest + sha)
        run: |
          set -euo pipefail
          IMAGE_BASE="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/miar-pr8-${{ matrix.service }}"
          IMAGE_LATEST="${IMAGE_BASE}:latest"
          IMAGE_SHA="${IMAGE_BASE}:${{ github.sha }}"

          echo "Building service: ${{ matrix.service }}"
          echo "IMAGE_LATEST=${IMAGE_LATEST}"
          echo "IMAGE_SHA=${IMAGE_SHA}"

          docker build -f ./${{ matrix.service }}/Dockerfile -t "${IMAGE_LATEST}" -t "${IMAGE_SHA}" .
          docker push "${IMAGE_LATEST}"
          docker push "${IMAGE_SHA}"

  deploy-sls-yc:
    name: Deploy to Yandex Serverless Containers
    runs-on: ubuntu-latest
    needs: [build-and-push-ycr]
    strategy:
      matrix:
        service: [booking_service, cleaning_service]

    steps:
      - uses: actions/checkout@v4

      - name: ‚úÖ Verify deploy secrets presence (safe)
        run: |
          set -euo pipefail
          [ -n "${{ secrets.YC_KEYS }}" ] || (echo "YC_KEYS is EMPTY" && exit 1)
          [ -n "${{ secrets.FOLDER_ID }}" ] || (echo "FOLDER_ID is EMPTY" && exit 1)
          [ -n "${{ secrets.YC_REGISTRY_ID }}" ] || (echo "YC_REGISTRY_ID is EMPTY" && exit 1)
          [ -n "${{ secrets.SA_ID }}" ] || (echo "SA_ID is EMPTY" && exit 1)

          echo "FOLDER_ID length: ${#{{ secrets.FOLDER_ID }}}"
          echo "FOLDER_ID prefix: $(echo '${{ secrets.FOLDER_ID }}' | cut -c1-4)***"
          echo "SA_ID prefix: $(echo '${{ secrets.SA_ID }}' | cut -c1-4)***"
          echo "REGISTRY prefix: $(echo '${{ secrets.YC_REGISTRY_ID }}' | cut -c1-3)***"

      - name: üîé Parse YC_KEYS JSON (safe IDs only)
        env:
          YC_KEYS: ${{ secrets.YC_KEYS }}
        run: |
          set -euo pipefail
          python - <<'PY'
import json, os
j = json.loads(os.environ["YC_KEYS"])
print("YC_KEYS.service_account_id =", j.get("service_account_id"))
print("YC_KEYS.cloud_id          =", j.get("cloud_id"))
print("YC_KEYS.folder_id         =", j.get("folder_id"))
PY

      - name: Setup yc CLI
        uses: yc-actions/yc-setup@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_KEYS }}

      - name: üß™ Smoke: can list serverless containers (this is where PERMISSION_DENIED shows up)
        run: |
          set -euo pipefail
          yc --version

          echo "Listing containers in folder=${{ secrets.FOLDER_ID }} ..."
          # –ï—Å–ª–∏ —Ç—É—Ç PERMISSION_DENIED ‚Äî –∑–Ω–∞—á–∏—Ç —É SA –∏–∑ YC_KEYS –Ω–µ—Ç –ø—Ä–∞–≤ serverless-containers.*
          yc serverless container list --folder-id "${{ secrets.FOLDER_ID }}"

      - name: üß™ Smoke: can get runtime service account
        run: |
          set -euo pipefail
          echo "Getting runtime SA (SA_ID) ..."
          yc iam service-account get "${{ secrets.SA_ID }}" || true

      - name: üß™ Smoke: can access registry by ID (pull permissions might be needed for runtime)
        run: |
          set -euo pipefail
          yc container registry get "${{ secrets.YC_REGISTRY_ID }}" || true

      - name: Deploy to Yandex Serverless Containers (SHA revision)
        uses: yc-actions/yc-sls-container-deploy@v4
        with:
          yc-sa-json-credentials: ${{ secrets.YC_KEYS }}
          folder-id: ${{ secrets.FOLDER_ID }}
          container-name: miar-pr8-${{ matrix.service }}

          # –¥–µ–ø–ª–æ–∏–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π SHA, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç latest
          revision-image-url: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/miar-pr8-${{ matrix.service }}:${{ github.sha }}

          # –∞–∫–∫–∞—É–Ω—Ç, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∏ —Ç—è–Ω—É—Ç—å –æ–±—Ä–∞–∑
          revision-service-account-id: ${{ secrets.SA_ID }}

          revision-cores: 1
          revision-memory: 512Mb
          revision-core-fraction: 100
          revision-concurrency: 8
          revision-env: |
            ENV=prod

      - name: ‚úÖ Post-check: show deployed container
        run: |
          set -euo pipefail
          echo "Container name: miar-pr8-${{ matrix.service }}"
          yc serverless container get --name "miar-pr8-${{ matrix.service }}" --folder-id "${{ secrets.FOLDER_ID }}" || true

  all-deployed:
    name: All deployed
    runs-on: ubuntu-latest
    needs: [test-before-deploy, build-and-push-ycr, deploy-sls-yc]
    steps:
      - name: Done
        run: |
          echo "Yandex CD OK"
          echo "  - Tests: OK"
          echo "  - Pushed to YCR: OK"
          echo "  - Deployed SLS containers: OK"