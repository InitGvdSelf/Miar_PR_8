name: CD - Build, Test and Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  # 1) Тесты (один раз на весь проект)
  test-before-deploy:
    name: Test before deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install -r booking_service/requirements.txt
          pip install -r cleaning_service/requirements.txt
          pip install pytest pytest-cov httpx prometheus-fastapi-instrumentator

      - name: Run unit tests (if exist)
        run: |
          set -euo pipefail
          export PYTHONPATH="$GITHUB_WORKSPACE"
          if ls tests/test_*_unit.py >/dev/null 2>&1; then
            pytest -q tests/test_*_unit.py -v --tb=short
          else
            echo "No unit tests found, skipping..."
          fi

      - name: Run integration tests (if exist)
        run: |
          set -euo pipefail
          export PYTHONPATH="$GITHUB_WORKSPACE"
          if ls tests/test_*_integration.py >/dev/null 2>&1; then
            pytest -q tests/test_*_integration.py -v --tb=short
          else
            echo "No integration tests found, skipping..."
          fi

  # 2) Build+Push в Yandex Container Registry (как в методичке)
  build-and-push-ycr:
    name: Build and push to YC Registry
    runs-on: ubuntu-latest
    needs: [test-before-deploy]
    strategy:
      fail-fast: false
      matrix:
        service: [booking_service, cleaning_service]

    steps:
      - uses: actions/checkout@v4

      - name: Check YC secrets present
        env:
          YC_KEYS: ${{ secrets.YC_KEYS }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          set -euo pipefail
          [ -n "${YC_KEYS:-}" ] || (echo "YC_KEYS is EMPTY" && exit 1)
          [ -n "${YC_REGISTRY_ID:-}" ] || (echo "YC_REGISTRY_ID is EMPTY" && exit 1)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to YC Registry
        uses: docker/login-action@v3
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_KEYS }}

      - name: Build docker image
        env:
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          set -euo pipefail
          IMAGE_BASE="cr.yandex/${YC_REGISTRY_ID}/miar-pr8-${{ matrix.service }}"
          docker build . \
            --file ./${{ matrix.service }}/Dockerfile \
            --tag "${IMAGE_BASE}:latest" \
            --tag "${IMAGE_BASE}:${GITHUB_SHA}"

      - name: Push tag to YC Registry
        env:
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          set -euo pipefail
          IMAGE_BASE="cr.yandex/${YC_REGISTRY_ID}/miar-pr8-${{ matrix.service }}"
          docker push "${IMAGE_BASE}:latest"
          docker push "${IMAGE_BASE}:${GITHUB_SHA}"

  # 3) Deploy в Serverless Containers (оставляем как у тебя, но уже после пуша в YCR)
  deploy-sls-yc:
    name: Deploy serverless containers
    runs-on: ubuntu-latest
    needs: [build-and-push-ycr]
    strategy:
      fail-fast: false
      matrix:
        service: [booking_service, cleaning_service]

    steps:
      - name: Check deploy secrets present
        env:
          YC_KEYS: ${{ secrets.YC_KEYS }}
          FOLDER_ID: ${{ secrets.FOLDER_ID }}
          SA_ID: ${{ secrets.SA_ID }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          set -euo pipefail
          [ -n "${YC_KEYS:-}" ] || (echo "YC_KEYS is EMPTY" && exit 1)
          [ -n "${FOLDER_ID:-}" ] || (echo "FOLDER_ID is EMPTY" && exit 1)
          [ -n "${SA_ID:-}" ] || (echo "SA_ID is EMPTY" && exit 1)
          [ -n "${YC_REGISTRY_ID:-}" ] || (echo "YC_REGISTRY_ID is EMPTY" && exit 1)

      - name: Deploy to Yandex Serverless Containers
        uses: yc-actions/yc-sls-container-deploy@v4
        with:
          yc-sa-json-credentials: ${{ secrets.YC_KEYS }}
          folder-id: ${{ secrets.FOLDER_ID }}
          container-name: miar-pr8-${{ matrix.service }}
          revision-image-url: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/miar-pr8-${{ matrix.service }}:${{ github.sha }}
          revision-service-account-id: ${{ secrets.SA_ID }}
          revision-cores: 1
          revision-memory: 512Mb
          revision-core-fraction: 100
          revision-concurrency: 8
          revision-env: |
            ENV=prod

  all-deployed:
    name: All deployed
    runs-on: ubuntu-latest
    needs: [test-before-deploy, build-and-push-ycr, deploy-sls-yc]
    steps:
      - name: Done
        run: |
          echo "Yandex CD OK"
          echo "  - Tests: OK"
          echo "  - Pushed to YCR: OK"
          echo "  - Deployed SLS containers: OK"